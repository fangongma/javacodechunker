{
  "language" : "java",
  "filePath" : "D:\\Learning\\Git\\sftp\\src\\main\\java\\jp\\co\\jri\\epix\\sftp\\config\\SftpConfig.java",
  "chunkId" : "jp.co.jri.epix.sftp.config.SftpConfig",
  "kind" : "CLASS",
  "name" : "SftpConfig",
  "parent" : {
    "namespace" : "jp.co.jri.epix.sftp.config",
    "classes" : [ ]
  },
  "signature" : "public class SftpConfig",
  "location" : {
    "startLine" : 36,
    "endLine" : 238
  },
  "imports" : [ "com.jcraft.jsch.ChannelSftp", "jp.co.jri.epix.sftp.mapper.ApiAccessMapper", "jp.co.jri.epix.sftp.model.ApiAccess", "jp.co.jri.epix.sftp.service.SftpService", "org.apache.logging.log4j.LogManager", "org.apache.logging.log4j.Logger", "org.springframework.beans.factory.annotation.Value", "org.springframework.context.annotation.Bean", "org.springframework.context.annotation.Configuration", "org.springframework.expression.common.LiteralExpression", "org.springframework.integration.annotation.IntegrationComponentScan", "org.springframework.integration.channel.DirectChannel", "org.springframework.integration.channel.NullChannel", "org.springframework.integration.config.EnableIntegration", "org.springframework.integration.dsl.IntegrationFlow", "org.springframework.integration.dsl.IntegrationFlows", "org.springframework.integration.file.FileHeaders", "org.springframework.integration.file.remote.RemoteFileTemplate", "org.springframework.integration.file.remote.session.CachingSessionFactory", "org.springframework.integration.handler.advice.ErrorMessageSendingRecoverer", "org.springframework.integration.handler.advice.RequestHandlerRetryAdvice", "org.springframework.integration.sftp.outbound.SftpMessageHandler", "org.springframework.integration.sftp.session.DefaultSftpSessionFactory", "org.springframework.messaging.Message", "org.springframework.messaging.MessageChannel", "org.springframework.messaging.MessageHandler", "org.springframework.retry.backoff.FixedBackOffPolicy", "org.springframework.retry.interceptor.MethodInvocationRecoverer", "org.springframework.retry.interceptor.RetryInterceptorBuilder", "org.springframework.retry.interceptor.RetryOperationsInterceptor", "org.springframework.retry.policy.SimpleRetryPolicy", "org.springframework.retry.support.RetryTemplate" ],
  "modifiers" : [ "public " ],
  "symbols" : {
    "classes" : [ "SftpConfig" ],
    "methods" : [ "SftpConfig", "getHost", "setHost", "getPort", "setPort", "getUser", "setUser", "getPassword", "setPassword", "getRemoteDirectory", "setRemoteDirectory", "getLocalDirectory", "setLocalDirectory", "getMaxAttempts", "setMaxAttempts", "getRetryDelay", "setRetryDelay", "getPrivateKeyPath", "setPrivateKeyPath", "getPrivateKeyPassphrase", "setPrivateKeyPassphrase", "sftpSessionFactory", "remoteFileTemplate", "sftpMessageHandler", "toSftpChannel", "sftpUploadFlow", "sftpRetryAdvice" ],
    "fields" : [ "logger", "apiAccessMapper", "host", "port", "user", "password", "privateKeyPath", "privateKeyPassphrase", "remoteDirectory", "localDirectory", "maxAttempts", "retryDelay" ],
    "variables" : [ "factory", "template", "handler", "advice", "retryTemplate", "retryPolicy", "backOffPolicy", "failedMessage" ]
  },
  "code" : "@Configuration\r\n@EnableIntegration\r\n@IntegrationComponentScan\r\npublic class SftpConfig {\r\n\r\n    private static final Logger logger = LogManager.getLogger(SftpService.class);\r\n\r\n    private final ApiAccessMapper apiAccessMapper;\r\n\r\n    @Value(\"${sftp.host}\")\r\n    private String host;\r\n\r\n    @Value(\"${sftp.port}\")\r\n    private int port;\r\n\r\n    @Value(\"${sftp.user}\")\r\n    private String user;\r\n\r\n    // for user id and password authentication\r\n    @Value(\"${sftp.password}\")\r\n    private String password;\r\n\r\n    // <-- for private key authentication\r\n    @Value(\"${sftp.privateKeyPath}\")\r\n    private String privateKeyPath;\r\n\r\n    // -->\r\n    @Value(\"${sftp.privateKeyPassphrase:}\")\r\n    private String privateKeyPassphrase;\r\n\r\n    @Value(\"${sftp.remote-directory}\")\r\n    private String remoteDirectory;\r\n\r\n    @Value(\"${sftp.local-directory}\")\r\n    private String localDirectory;\r\n\r\n    @Value(\"${sftp.retry.max-attempts}\")\r\n    private int maxAttempts;\r\n\r\n    @Value(\"${sftp.retry.delay}\")\r\n    private long retryDelay;\r\n\r\n    public SftpConfig(ApiAccessMapper apiAccessMapper) {\r\n        this.apiAccessMapper = apiAccessMapper;\r\n    }\r\n\r\n    public String getHost() {\r\n        return host;\r\n    }\r\n\r\n    public void setHost(String host) {\r\n        this.host = host;\r\n    }\r\n\r\n    public int getPort() {\r\n        return port;\r\n    }\r\n\r\n    public void setPort(int port) {\r\n        this.port = port;\r\n    }\r\n\r\n    public String getUser() {\r\n        return user;\r\n    }\r\n\r\n    public void setUser(String user) {\r\n        this.user = user;\r\n    }\r\n\r\n    public String getPassword() {\r\n        return password;\r\n    }\r\n\r\n    public void setPassword(String password) {\r\n        this.password = password;\r\n    }\r\n\r\n    public String getRemoteDirectory() {\r\n        return remoteDirectory;\r\n    }\r\n\r\n    public void setRemoteDirectory(String remoteDirectory) {\r\n        this.remoteDirectory = remoteDirectory;\r\n    }\r\n\r\n    public String getLocalDirectory() {\r\n        return localDirectory;\r\n    }\r\n\r\n    public void setLocalDirectory(String localDirectory) {\r\n        this.localDirectory = localDirectory;\r\n    }\r\n\r\n    public int getMaxAttempts() {\r\n        return maxAttempts;\r\n    }\r\n\r\n    public void setMaxAttempts(int maxAttempts) {\r\n        this.maxAttempts = maxAttempts;\r\n    }\r\n\r\n    public long getRetryDelay() {\r\n        return retryDelay;\r\n    }\r\n\r\n    public void setRetryDelay(long retryDelay) {\r\n        this.retryDelay = retryDelay;\r\n    }\r\n\r\n    public String getPrivateKeyPath() {\r\n        return privateKeyPath;\r\n    }\r\n\r\n    public void setPrivateKeyPath(String privateKeyPath) {\r\n        this.privateKeyPath = privateKeyPath;\r\n    }\r\n\r\n    public String getPrivateKeyPassphrase() {\r\n        return privateKeyPassphrase;\r\n    }\r\n\r\n    public void setPrivateKeyPassphrase(String privateKeyPassphrase) {\r\n        this.privateKeyPassphrase = privateKeyPassphrase;\r\n    }\r\n\r\n    @Bean\r\n    public CachingSessionFactory<ChannelSftp.LsEntry> sftpSessionFactory() {\r\n        //        ApiAccess apiAccess = apiAccessMapper.findApiAccessByApplication(\"Trade\");\r\n        //        logger.debug(\"application=\" + apiAccess.getApplication());\r\n        //        logger.debug(\"component=\" + apiAccess.getComponent());\r\n        //        logger.debug(\"apiKey=\" + apiAccess.getApiKey());\r\n        //        logger.debug(\"expiryDate=\" + apiAccess.getExpiryDate());\r\n        //        logger.debug(\"neverExpired=\" + apiAccess.getNeverExpired());\r\n        DefaultSftpSessionFactory factory = new DefaultSftpSessionFactory(true);\r\n        factory.setHost(host);\r\n        factory.setPort(port);\r\n        factory.setUser(user);\r\n        // for user id and password authentication\r\n        factory.setPassword(password);\r\n        // for private key authentication\r\n        //        factory.setPrivateKey(new FileSystemResource(privateKeyPath));\r\n        //        logger.debug(\"privateKeyPath=\" + privateKeyPath);\r\n        //        if (privateKeyPassphrase != null && !privateKeyPassphrase.isEmpty()) {\r\n        //            factory.setPrivateKeyPassphrase(privateKeyPassphrase);\r\n        //            logger.debug(\"privateKeyPassphrase=\" + privateKeyPassphrase);\r\n        //        }\r\n        // optionally disable strict host key checking\r\n        factory.setAllowUnknownKeys(true);\r\n        return new CachingSessionFactory<>(factory);\r\n    }\r\n\r\n    @Bean\r\n    public RemoteFileTemplate<ChannelSftp.LsEntry> remoteFileTemplate() {\r\n        RemoteFileTemplate<ChannelSftp.LsEntry> template = new RemoteFileTemplate<>(sftpSessionFactory());\r\n        template.setRemoteDirectoryExpression(new LiteralExpression(remoteDirectory));\r\n        template.setAutoCreateDirectory(true);\r\n        return template;\r\n    }\r\n\r\n    @Bean\r\n    public MessageHandler sftpMessageHandler() {\r\n        SftpMessageHandler handler = new SftpMessageHandler(sftpSessionFactory());\r\n        handler.setRemoteDirectoryExpression(new LiteralExpression(remoteDirectory));\r\n        handler.setAutoCreateDirectory(true);\r\n        handler.setFileNameGenerator(message -> (String) message.getHeaders().get(FileHeaders.REMOTE_FILE));\r\n        return handler;\r\n    }\r\n\r\n    @Bean\r\n    public MessageChannel toSftpChannel() {\r\n        return new DirectChannel();\r\n    }\r\n\r\n    @Bean\r\n    public IntegrationFlow sftpUploadFlow() {\r\n        return IntegrationFlows.from(toSftpChannel()).split().handle(sftpMessageHandler(), e -> e.advice(sftpRetryAdvice())).get();\r\n    }\r\n\r\n    @Bean\r\n    public RequestHandlerRetryAdvice sftpRetryAdvice() {\r\n        RequestHandlerRetryAdvice advice = new RequestHandlerRetryAdvice();\r\n        RetryTemplate retryTemplate = new RetryTemplate();\r\n        SimpleRetryPolicy retryPolicy = new SimpleRetryPolicy();\r\n        retryPolicy.setMaxAttempts(maxAttempts);\r\n        FixedBackOffPolicy backOffPolicy = new FixedBackOffPolicy();\r\n        // in ms\r\n        backOffPolicy.setBackOffPeriod(retryDelay);\r\n        retryTemplate.setRetryPolicy(retryPolicy);\r\n        retryTemplate.setBackOffPolicy(backOffPolicy);\r\n        advice.setRetryTemplate(retryTemplate);\r\n        // Optional: log or handle final failure\r\n        advice.setRecoveryCallback(context -> {\r\n            Message<?> failedMessage = (Message<?>) context.getAttribute(\"message\");\r\n            System.err.println(\"SFTP upload permanently failed: \" + failedMessage);\r\n            return null;\r\n        });\r\n        return advice;\r\n    }\r\n}",
  "notes" : { }
}